name: ğŸ”„ Hohai Auto Checkin

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶è§¦å‘
  schedule:
    # 2æ¬¡ç­¾åˆ°ï¼Œç¡®ä¿ä¸æ¼ç­¾
    - cron: "32 1 * * *"
    - cron: "55 14 * * *"

# æƒé™é…ç½®ï¼šå…è®¸æäº¤å’Œæ¨é€æ›´æ”¹
permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PROJECT_DIR: hohai
      SCRIPT_NAME: hohai_checkin.py
      SCRIPT_DESC: Hohai ç­¾åˆ°è„šæœ¬
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºå…¬å¼€ä»“åº“
      - name: ğŸ“¥ æ£€å‡ºå…¬å¼€ä»“åº“
        uses: actions/checkout@v4
      
      # æ­¥éª¤ 1.5: åˆ›å»ºè¾“å‡ºç›®å½•
      - name: ğŸ“ åˆ›å»ºè¾“å‡ºç›®å½•
        run: mkdir -p ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}
        working-directory: .
      
      # æ­¥éª¤ 2: æ£€å‡ºç§æœ‰ä»“åº“
      - name: ğŸ” æ£€å‡ºç§æœ‰ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: jyucoeng/auto_hohai_private
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: main
          path: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}
          fetch-depth: 1

      # æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # æ­¥éª¤ 4: å®‰è£…ç³»ç»Ÿä¾èµ–
      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb fonts-noto-cjk

      # æ­¥éª¤ 5: å®‰è£… Python ä¾èµ–
      - name: ğŸ“š å®‰è£… Python ä¾èµ–
        run: |
          pip install requests seleniumbase pyvirtualdisplay
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ æœªæ‰¾åˆ° requirements.txtï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
          fi
        working-directory: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}

      # æ­¥éª¤ 5.5: å®‰è£… Hysteria2ï¼ˆå¦‚æœéœ€è¦ä»£ç†ï¼‰
      - name: ğŸ“¡ å®‰è£… Hysteria2
        run: |
          if [ -n "${{ secrets.HY2_PROXY_URL }}" ]; then
            echo "å®‰è£… Hysteria2..."
            curl -L -o hysteria \
              https://github.com/apernet/hysteria/releases/latest/download/hysteria-linux-amd64
            chmod +x hysteria
            sudo mv hysteria /usr/local/bin/hysteria
            hysteria version
            echo "âœ… Hysteria2 å®‰è£…å®Œæˆ"
          else
            echo "âš ï¸ æœªé…ç½®ä»£ç†ï¼Œè·³è¿‡ Hysteria2 å®‰è£…"
          fi

      # æ­¥éª¤ 6: æ·»åŠ éšæœºå»¶è¿Ÿ
      - name: â³ æ·»åŠ éšæœºå»¶è¿Ÿ
        run: |
          delay=$((RANDOM % 120))
          echo "éšæœºå»¶è¿Ÿ: ${delay}ç§’"
          sleep $delay

      # æ­¥éª¤ 7: æ‰§è¡Œè„šæœ¬
      - name: ğŸš€ æ‰§è¡Œ ${{ env.SCRIPT_DESC }}
        env:
          HOHAI_BATCH: ${{ secrets.HOHAI_BATCH }}
          HY2_PROXY_URL: ${{ secrets.HY2_PROXY_URL }}
          SOCKS_PORT: ${{ secrets.SOCKS_PORT || '51080' }}
        run: xvfb-run -a python ${{ env.SCRIPT_NAME }}
        working-directory: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}

      # æ­¥éª¤ 8: æäº¤æ—¶é—´æ–‡ä»¶åˆ°å…¬å¼€åº“
      - name: â±ï¸ æäº¤æ—¶é—´æ–‡ä»¶
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          mkdir -p hohai && echo "$(date +'%Y-%m-%d %H:%M:%S')" > hohai/time.txt
          git add hohai/time.txt 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
            git commit -m "â±ï¸ æ›´æ–° hohai æ—¶é—´æ–‡ä»¶: $TIMESTAMP"
            git fetch origin main
            git push -f origin HEAD:main
            echo "âœ… æ›´æ”¹å·²æ¨é€"
          fi
